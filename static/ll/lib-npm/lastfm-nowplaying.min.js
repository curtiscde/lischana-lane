angular.module("lastfm-nowplaying",[]).directive("lastfmnowplaying",["uiCreation","lastFmAPI","lastFmParser",function(t,e,n){return{scope:{config:"=config"},link:function(a,i,r){a.$watch("config",function(t){l()});var l=function(){e.getLatestScrobbles(a.config).then(function(e){var r=n.getLatestTrack(e);angular.forEach(i,function(e,n){angular.element(i).addClass("lastfm-nowplaying"),t.create(e,a,r)})},function(t){})}}}}]).factory("uiCreation",["$q","canvasUI",function(t,e){var n=function(n,a,i){n.innerHTML="";var r=document.createElement("canvas");n.appendChild(r);var l=t.defer();return e.applyUI(n,r,i,function(){setTimeout(function(){var t=e.getAverageCanvasColor(r),n=!1;.299*t.r+.587*t.g+.114*t.b>186&&(n=!0),l.resolve({useBlackText:n})},200)}),l.promise},a=function(t,e){var n=document.createElement("div");angular.element(n).attr("style","background-image:url("+e+");").addClass("artwork"),t.appendChild(n)},i=function(t,e,n){var a=document.createElement("h3");angular.element(a).text(e.nowplaying?"Now Playing":"Listening To");var i=document.createElement("p");angular.element(i).addClass("track").text(e.title);var r=document.createElement("p");angular.element(r).addClass("artist").text(e.artist);var l=document.createElement("div");angular.element(l).addClass("text"),angular.element(l).toggleClass("black",n),l.appendChild(a),l.appendChild(i),l.appendChild(r),t.appendChild(l)};return{create:function(t,e,r){n(t,e,r.xLargeImgUrl).then(function(n){angular.element(t).find("div").remove();var l=document.createElement("div");e.config.containerClass&&angular.element(l).addClass(e.config.containerClass),a(l,r.largeImgUrl),i(l,r,n.useBlackText),t.appendChild(l)})}}}]).factory("lastFmAPI",["$q","$http",function(t,e){return{getLatestScrobbles:function(n){var a=t.defer();if(n&&n.user&&n.apiKey){var i="http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user="+n.user+"&api_key="+n.apiKey+"&format=json&limit=1";e.get(i).then(function(t){a.resolve(t)})}else a.reject("user or apiKey missing");return a.promise}}}]).factory("lastFmParser",[function(){return{getLatestTrack:function(t){var e=t.data.recenttracks.track[0];return{title:e.name,artist:e.artist["#text"],largeImgUrl:e.image[2]["#text"],xLargeImgUrl:e.image[3]["#text"],nowplaying:e["@attr"]&&e["@attr"].nowplaying}}}}]).factory("canvasUI",["imageFx",function(t){return{applyUI:function(e,n,a,i){t.blur(e,n,6,a,function(){i()})},getAverageCanvasColor:function(t){for(var e=t.width,n=t.height,a=t.getContext("2d").getImageData(0,0,e,n).data,i=0,r=0,l=0,o=0,c=a.length;o<c;o+=4)i+=a[o],r+=a[o+1],l+=a[o+2];return i=Math.floor(i/(a.length/4)),r=Math.floor(r/(a.length/4)),l=Math.floor(l/(a.length/4)),{r:i,g:r,b:l}}}}]).factory("imageFx",["$window","$timeout",function(t,e){var n=function(t,e){this.image=e,this.element=t,this.element.width=this.image.width,this.element.height=this.image.height,this.context=this.element.getContext("2d"),this.context.drawImage(this.image,0,0)};n.prototype={blur:function(t){this.context.globalAlpha=.5;for(var e=-t;e<=t;e+=2)for(var n=-t;n<=t;n+=2)this.context.drawImage(this.element,n,e),n>=0&&e>=0&&this.context.drawImage(this.element,-(n-1),-(e-1));this.context.globalAlpha=1}};var a=function(t,e,n){var a=0,i=0;n.width/n.height>t.clientWidth/t.clientHeight?(e.style.height=t.clientHeight+"px",e.style.width=e.clientHeight*(n.width/n.height)+"px",a=t.clientWidth-e.clientWidth):(e.style.width=t.clientWidth+"px",e.style.height=e.clientWidth*(n.height/n.width)+"px"),i=(e.clientHeight-t.clientHeight)/2*-1,e.style.marginLeft=a+"px",e.style.marginTop=i+"px"},i=function(e,i,r,l,o){var c,s,g=function(){a(e,i,c)};(c=document.createElement("img")).crossOrigin="Anonymous",c.onload=function(){(s=new n(i,this)).blur(r),g(),o&&o()},c.src=l,angular.element(t).bind("resize",function(){g()})};return{blur:function(e,n,a,r,l){return!!!!t.HTMLCanvasElement&&i(e,n,a,r,l)}}}]);